# 07_部署运维与发布流程

## 7.1 生产环境拓扑与流量调度引擎设计
EasyStay 平台在生产环境的部署架构选用了容器化基础设施与高性能流量网关相结合的策略。整个流量的分发中枢由 Nginx 承载，它通过单 IP、多路径的分发模式实现了全站入口的统一化。在我们的 Nginx 配置（nginx.conf）中，通过精心设计的静态资源 Alias 与代理规则，实现了对三个不同性质工程的无缝聚合。具体而言，网站根路径（/）被配置为永久重定向至移动端入口（/mobile/），而后台管理系统（/admin/）与 API 服务（/api/）则分属不同的处理域。这种利用子路径进行逻辑隔离的方案，避免了多域名带来的跨域 CORS 难题，也极大地简化了 SSL 证书的部署与维护成本。

针对 API 服务的反向代理，Nginx 内部执行了细致的请求头透传逻辑，确保后端 Node.js 应用能够精确感知访客的真实 IP 以及原始请求协议。这种配置对于我们集成 LBS 定位服务至关重要。与此同时，为了优化静态文件的加载效率，所有的 H5 构建产物（admin-web 与 mobile-app 的 dist 目录）均直接交由 Nginx 处理，而非经由应用层托管。这种直接的静态文件映射，利用了 Nginx 的 sendfile 和 gzip 压缩技术，使页面的首屏资源加载速度得到了质的提升。通过这种动静分离的架构，系统实现了在单机环境下支撑较高并发能力的工程目标。

## 7.2 后端服务持久化与进程管理策略
核心数据的存储稳定性由 Docker Compose 驱动的 MySQL 8.0 容器集群保证。我们对数据库容器进行了深度的持久化配置：通过宿主机目录（`mysql_data`）的物理挂载，实现了数据的生命周期与容器生命周期的解耦。即便在 Docker 守护进程重启或容器销毁的情况下，真实的业务订单与酒店元数据依然安全地保存在宿主机的磁盘阵列中。在端口策略上，我们将容器内部的标准 3306 端口映射到了宿主机的 3307 端口，这种非对称的端口映射有效规避了与服务器已有数据库服务的冲突，同时也增加了一层简单的网络隐蔽性。

在应用进程的生命周期管理上，系统引入了 PM2 这一强大的生产级进程守护工具。每一个运行中的 Node.js 实例都受 PM2 的监控，其具备的自动重启（Auto-restart）机制确保了在由于突发内存溢出或未捕获异常导致进程崩溃后，系统能在毫秒级实现自我复原。在发布流程中，我们并未采取粗暴的 kill 进程再重启的方式，而是利用了 PM2 的 `reload` 指令。这种“热重载”技术通过逐个重启集群模式下的各个工作线程，实现了真正的零停机布署（Zero-downtime Deployment），保证了用户在系统更新期间依然能够平稳进行酒店检索与下单操作。

## 7.3 自动化发布流水线：update.sh 脚本深度逻辑
项目自研的 `update.sh` 发布脚本是整个运维体系的工程化结晶。该脚本严格遵循 Shell 编程的 Robust 规范，在开头即声明了 `set -euo pipefail`，这意味着任何未定义的变量引用或命令执行失败都会立即熔断脚本流程，防止出现部分更新导致的系统由于脏状态崩溃。脚本的执行逻辑被设计为一个幂等的闭环：它首先同步 Gitee 远程仓库代码，通过 `git reset --hard` 清理任何环境污染，随后自动进入后端目录执行生产依赖的剪裁安装。这种全自动化的流程将由人工操作失误引起的发布事故率几乎降为零。

在静态资产的分发上，脚本展现了极高的灵活性。它首先通过检测前端工程的 `dist` 目录是否存在，来决定是否触发基于 `rsync` 的增量同步任务。同步动作不仅包含了文件的物理拷贝，还通过递归权限设置确保了 Nginx 运行用户（www-data）能够具备正确的读取权限。最后，脚本会触发 Nginx 的配置校验（nginx -t），只有在语法格式完全正确的前提下才会执行 `nginx -s reload`。这种“先校验、后应用”的防御性运维策略，配合 GitHub Actions 同步工作流，使得 EasyStay 的发布链路既具备了持续集成的敏捷性，又拥有了准生产级的可靠性。

## 7.4 安全基信与可观测性体系建设
安全始终是 EasyStay 运维逻辑中的最高优先级。尽管在演示环境中我们使用了便于调试的 `.env` 方式管理配置，但我们在架构建议中详细说明了生产环境的整改方案，即利用操作系统的环境变量注入（Environment Injection）来承载敏感的第三方 Secret 和数据库凭证。对于上传目录（uploads），我们通过 Nginx 的路径别名实现了与应用代码的解耦，并在后续建议中提出了对该目录进行白名单访问控制的想法。这种对“攻击面最小化”的追求，渗透到了从 Docker 网络隔离到 JWT 秘钥轮换的每一个环节。

可观测性方面，后端的日志策略在开发与生产模式间进行了精细切换。在开发模式下，Sequelize 被配置为输出全量的 SQL 语句以便快速定位 ORM 映射问题；而在生产模式中，这种冗长的 I/O 被自动抑制，取而代之的是结构化的异常日志。我们建议在未来的运维演进中引入 requestId 全链路追踪机制，并在 Nginx 侧配置请求响应时长的观测指标。这种从单一脚本发布向完整 DevOps 闭环演进的思路，明确了平台不仅是一个独立的应用，更是一个具备自我诊断、自我修复能力的成熟工程实体。
