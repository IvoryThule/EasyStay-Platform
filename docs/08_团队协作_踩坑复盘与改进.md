# 08_团队协作_踩坑复盘与改进

## 8.1 跨端协作模型与工程规范定义
EasyStay 项目的交付过程是一场典型的异构系统联调实践。在协作模型的设计上，我们采取了“核心共享，边界清晰”的开发策略。后端作为全局数据契约的制定者，通过在项目初期冻结 API 响应结构和 JWT 协议，为管理后台与移动端的并行开发提供了稳定的基座。工程组织上，尽管项目分布在多个子目录下，但通过统一的 `dev_log.md` 和各层级的执行手册，各模块负责人可以实现跨时区的进度对齐与风险预警。这种基于文档驱动的异步协作模式，极大地缓解了由于前后端进度不一导致的集成阵痛，确保了项目从原型阶段向闭环系统的平滑过渡。

为了维持代码质量的一致性，各端在开发过程中遵循了不同层次的工程规范。后端通过 Sequelize 模型关联实现了数据结构的自注释，前端则通过组件化的 UI 定义实现了业务逻辑的可复用性。仓库中保留的测试脚本（如 `test_backend_full.ps1`）不仅是技术资产，更是团队成员间传递“可工作的代码”这一共识的物理媒介。在演示阶段，这种通过自动化脚本快速复现 Bug 或演示功能的手段，被证明是提升集成效率、降低沟通成本的最优策略。

## 8.2 技术性缺陷复盘：RBAC 实现与前端落地的漂移分析
在项目集成后的全路径审核过程中，我们发现了一个典型的“架构腐化”案例。在设计文档中，我们明确规范了管理员审核动作应通过 `/api/admin/hotel/audit` 专用接口执行，并配合了严密的 RBAC 角色过滤。然而在实际的前端（admin-web）落地中，审核页面由于为了适配早期联调代码，直接复用了商户编辑专用的 `/api/hotel/update` 接口，通过传参方式强制修改 `status` 字段。这种实现层面的漂移，导致后端的管理员权限拦截层在实际审核场景中被由于逻辑重叠而“绕过”，不仅削弱了系统在生产环境下的安全边界，也给未来的状态机重构留下了隐患。

通过对该问题的根因分析（Root Cause Analysis），我们意识到这是由于“单体 API 内部权限交叉”与“缺乏自动化契约校验”共同导致的。虽然 `/hotel/update` 逻辑上能够完成任务，但它混淆了不同角色的语义边界。针对这一深度技术债，我们制定了明确的整改方案：前端必须强制切回到专用的管理员接口，而后端则需在 `hotel/update` 逻辑中加入更严格的校验逻辑，禁止非管理员用户在调用更新接口时直接触碰 `status` 字段。这种复盘不仅是一次代码层面的修正，更是对“契约优于实现”这一工程准则的深刻补课。

## 8.3 部署链路缺陷复盘：Nginx 子路径与路径硬编码之惑
另一个在灰度发布阶段暴露出的严峻挑战，源于对 Nginx 子路径部署（Subpath Deployment）复杂度的低估。由于平台将后台管理系统与移动端分别托管在 `/admin/` 和 `/mobile/` 之下，前端路由系统对这种路径层级的敏感性导致了初期的白屏灾难。移动端存在的资源 host 硬编码问题，使得原本在开发环境下正常的图片请求，在通过反向代理后出现了大量的 404 异常。这种缺陷暴露出我们在环境抽象（Environment Abstraction）方面的不足，即代码中未能完全将“资源基座地址”与“具体业务路径”进行有效的常量化解耦。

为了彻底消除这一隐患，我们对全站的资源请求链路进行了重构。在移动端，通过动态获取当前 URL 基座并配合 Taro 的环境变量策略，实现了不同环境下的静默适配；在管理后台，则通过 Vite 的 `base` 选项重新对齐了静态产物的引用路径。经验表明，对于复杂的 Web 工程，环境适配能力应当在架构初期就作为非功能需求（NFR）进行强制约束。未来的优化重点将放在建立统一的配置中心（Configuration Center）上，通过在构建阶段注入环境镜像，将环境感知压力从业务代码中剥离，从根本上解决“本地跑得通，线上打不开”的运维痼疾。

## 8.4 安全与稳健性改进策略建议
在对现有源码的深度审计中，我们还识别到了涉及持久化与资产安全的工程风险。最显著的问题是 `.env` 配置文件与 Docker Compose 明文密码在历史提交中的留存。这种做法在真实生产环境中属于最高级别的安全红线。我们计划实施的改进措施包括：利用 Git 过滤器重写历史提交以彻底抹除敏感足迹，并切换到完全基于服务器环境变量或容器机密（Docker Secrets）的注入模式。这种对“代码与凭证分离”的坚持，是平台走向合规化运营的必经之路。

长远视角下，EasyStay 的演进路线将聚焦于订单场景的强一致性优化。当前“下单即扣库存”的策略虽在演示环境下表现稳定，但在应对真实高并发预订流量时，极易诱发库存超卖。我们建议后续引入 Redis 预分配逻辑与带有“心跳过期”机制的可取消事务流，以构建更加抗压的库存扣减算法。此外，针对后端 `hotelController.js` 等核心模块中偶发的合并冲突残留痕迹，团队已建立 lint 预检机制，确保任何破坏代码完整性的冗余代码（Code Smells）都无法进入主分支。这种从细节处入手的极致追求，使得 EasyStay 系统不仅是一个能够展示的成品，更是一个在不断自省与重构中持续进化的工程载体。
