# 04_后端API与权限设计

## 4.1 RESTful API 设计规范与通信协议
EasyStay 平台的后端服务遵循严谨的 RESTful 架构风格，旨在通过标准化的 HTTP 动词与资源路径，构建一套高内聚、易扩展的接口体系。所有的业务能力均挂载在 `/api` 根路径下，通过 JSON 作为统一的数据交换格式。在通信链路的安全性上，系统强制要求使用 Bearer 认证方案。每一个受保护的资源请求，都必须在 Header 中携带通过鉴权签发的 JWT 令牌。这种设计不仅实现了无状态的水平扩展，更利用令牌的自包含特性，减少了后端对 Session 存储的依赖，极大提升了分布式环境下的响应效率。

为了确保前端消费接口的低成本与高一致性，后端设计并执行了统一的响应封装协议。无论业务成功与否，返回体均包含 `code` 业务码、`msg` 灰度提示信息以及 `data` 数据载荷。对于 401（未授权）、403（禁止访问）或 500（系统异常）等标准 HTTP 状态码，系统通过全局错误捕获中间件，将其映射为带有详细上下文的业务响应。这种规范化的契约标准，使得前端可以利用 axios 拦截器实现自动化的逻辑流转，显著降低了业务耦合度。

## 4.2 基于认证中间件的身份标识与注入逻辑
系统的核心安全壁垒构建在 `authMiddleware.js` 之上。该中间件在请求生命周期的早期阶段介入，利用 `jsonwebtoken` 库对传入的令牌进行完整性与有效期校验。校验逻辑不仅限于验证签名，还会解析出令牌中携带的用户 ID、角色及基本属性。验证通过后，该中间件会通过赋值操作将用户信息注入 `req.user` 上下文。这一“身份注入”机制是后续所有业务逻辑的基础，它确保了控制器层在处理酒店编辑或订单查询时，能够始终处于“已确认身份”的安全语境下，无需重复执行查询数据库验证用户的操作。

在身份标识的基础上，系统通过 `roleMiddleware.js` 实现了分层级的角色权限控制（RBAC）。该中间件采取了声明式的拦截逻辑，允许在路由定义阶段通过 `requireRole(['admin', 'merchant'])` 等语法直接声明准入权限。由于该中间件工作在业务控制器之前，它形成了一个有效的安全沙盒。如果当前访问者的角色位不在准入列表内，中间件将直接中断请求链并返回 403 响应，从而将鉴权压力挡在业务逻辑执行之外。这种设计既保证了代码的简洁性，又通过集中的权限矩阵降低了越权访问的风险。

## 4.3 控制器层的业务逻辑编排与资源所有权校验
进入控制器（Controller）层后，系统面临的挑战从“身份验证”转向了更复杂的“资源归属校验”。以酒店更新接口为例，仅具备 `merchant` 角色并不足以获得操作权限，系统必须验证该酒店的所有者（owner）是否为当前发起请求的用户。我们在控制器中实现了深度验证逻辑，通过主键查询并对比 `merchant_id` 字段，确保了横向越权攻击被彻底阻断。如果验证失败，控制器将显式抛出异常，触发统一的错误处理流程。

在业务原子性保障上，核心控制器广泛应用了数据库事务（Transaction）。典型的场景如酒店与房型的级联更新：当商户修改酒店信息并同步增删房型时，后端会开启一个全局事务，将旧房型的物理清理、新房型的批量插入以及酒店最低价的重算动作封装在一起。这种“全有或全无”的操作逻辑，配合 Sequelize 的 Upsert 能力，确保了即使在数据库异常波动的极端情况下，系统的业务状态也不会出现半完成的脏数据。这种对一致性的极致追求，是 EasyStay 后端服务成熟度的标志。

## 4.4 系统服务集成与第三方能力透传
平台后端不仅仅是一个 CRUD 引擎，它还作为一个高集成的 Service 调度中心。在系统路由（System Routes）下，后端集成了高德 LBS 定位服务。定位逻辑并不是简单的 API 转发，控制器会首先尝试从请求的 `X-Forwarded-For` 或 `RemoteAddr` 中提取真实 IP，随后通过 Amap 服务模块获取经纬度与城市代码。这种对原始信息的预处理，使得前端首页的“自动定位”功能可以实现秒级的静默感知。

对于 AI能力的集成，后端在控制器层实现了一套复杂的 Prompt 编排逻辑。在聊天助手的 API 中，后端需要维护一个轻量级的上下文窗口，将用户的历史对话与实时的酒店搜索语境拼接作为输入。通过封装 `GLMService` 的调用链路，控制器能够根据模型返回的结构化标签，动态决定是返回一段纯文本回复，还是返回一组经过清洗的酒店模型卡片。这种将外部 AI 能力与内部业务模型无缝缝合的能力，证明了 EasyStay 后端在处理异构数据流方面的技术深度。
