# 03_数据库设计与Sequelize模型

## 3.1 物理存储逻辑与连接池管理策略
EasyStay 平台选择了 MySQL 8.0 作为其核心关系型数据存储引擎。在生产与开发环境的统一性上，我们通过 Docker Compose 编排了一个容器化的实例，并将其物理端口映射到宿主机的 3307，有效隔离了环境依赖。后端应用层通过 Sequelize 这一高度成熟的 Node.js ORM 框架建立持久化连接。在连接配置上，我们不仅设置了 `timezone: '+08:00'` 以对齐业务所在的时区，更利用 `afterConnect` 钩子强制执行 `SET NAMES utf8mb4` 命令。这一防御性编程手段确保了系统在处理包含 Emoji 或多国语言的酒店评论与标签时，不会出现字符截断或编解码异常。

数据库安全性与鲁棒性在启动阶段即得到体现。项目采用 strict 模式读取 `server/.env` 配置文件，一旦检测到数据库密码或关键连接参数缺失，系统将通过 `process.exit(1)` 主动熔断，防止应用在非预期状态下启动。此外，Sequelize 的连接池通过默认策略维护，保证了在高并发查询场景下，数据库句柄能够被高效复用，从而显著降低了 TCP 握手带来的响应延迟。

## 3.2 实体关系建模与业务约束定义
平台的数据架构围绕着用户（User）、酒店（Hotel）、房型（RoomType）及订单（Order）四个核心维度展开。这种 ER 模型的设计深度嵌入了真实业务契约。在 `server/src/models/index.js` 中，我们定义了严密的关联矩阵。例如，商户用户与酒店之间建立了一对多的归属关系，这一关系不仅用于数据查询，更作为后端 RBAC 鉴权中判断资源所有权的物理依据。通过 `Hotel.merchant_id` 外键与 User 表的主键关联，系统实现了“谁发布，谁维护”的权限自动化隔离。

酒店与房型之间的关系则是多层级嵌套的典型应用。一个酒店实体可以挂载多个房型，我们在关联中使用了 `as: 'roomTypes'` 的别名。这种设计使得前端在请求酒店详情时，后端可以通过一个 `include` 指令触发 Left Join 查询，一次性获取完整的展示数据。这种预加载（Eager Loading）模式相比于多次查询，极大减少了数据库的 I/O 次数。同样地，订单表作为业务流的终点，通过三重外键复合关联了用户、酒店和具体的房型，形成了一个闭合的交易证据链。

## 3.3 酒店实体的状态机与灵活字段设计
在酒店（Hotel）表的设计上，我们平衡了结构化查询的需求与多媒体数据的灵活性。除了基础的名称、城市和星级等索引字段外，系统引入了 JSON 类型的 `images` 和 `tags` 字段。这种设计避免了创建繁琐的关联表，同时也适应了酒店展示中多图、多标签的非结构化特征。然而，在检索核心——价格维度上，我们采取了冗余策略。每当酒店名下的房型价格发生变动时，系统都会同步更新 Hotel 表的 `min_price` 字段。这种以空间换时间的策略，确保了在首页千万级展示请求下，系统无需进行跨表聚合即可快速完成价格排序。

酒店的生命周期管理则通过 `status` 整数型字段实现了一个闭环状态机。从初始录入的“待审核（0）”，到上架后的“发布（1）”，再到因合规问题触发的“驳回（2）”以及最终的“下线（3）”，每一个状态位都驱动着前端的可见性和后端的编辑规则。特别是在商户编辑逻辑中，任何敏感字段的修改都会自动将 `status` 重置为零。这种触发器式的设计，从数据底层保证了平台内容的真实可靠。

## 3.4 交易一致性与库存扣减算法
预订业务的核心挑战在于库存扣减的准确性。在 EasyStay 的实现中，房型（RoomType）实体的 `stock` 字段承载了实时的物理库存。虽然本项目在演示环境中采用了较为直观的同步扣减逻辑，即创建订单动作触发 `decrement` 原子操作，但在模型层面我们预留了事务支持。通过 Sequelize 的 Transaction 机制，系统可以将订单生成与库存变更绑定在一个原子单元内。一旦支付取消或流程异常，系统将通过 `increment` 操作回滚库存，确保物理实体的可用量在逻辑上守恒。

为了支撑管理后台的高效决策，数据库还承担了聚合分析的任务。在城市统计（City Stats）场景下，我们没有采用缓存预热，而是直接利用 MySQL 的分组聚合能力，通过对 `city` 字段的 `count` 统计实现实时的市场热度分析。这种基于 SQL 原生能力的实现方案，配合地理位置经纬度（latitude/longitude）字段的存储，为后续集成高德坐标变换与 POI 搜索奠定了坚实的数据基础。这种兼顾事务一致性与分析性能的数据库设计，使得平台能够平稳支撑从单点预订到多维度报表的复杂业务需求。
